{% extends "docia/base.html" %}

{% load dsfr_tags static %}


{% block content %}

  <h1>Dépenses éclairées</h1>

  <div class="fr-mb-10v">
    Rejoignez-nous sur Tchap et posez vos questions&nbsp;:
    <a target="_blank" href="{{ settings.TCHAP_SUPPORT_CANAL_URL }}">
      Support - Dépenses Éclairées
    </a>
  </div>

  {% if user.is_authenticated %}

    <form method="get">
      {{ form }}
      <div class="fr-input-group fr-my-4w">
        <button type="submit" class="fr-btn" title="Chercher">
          Chercher
        </button>
      </div>
    </form>

    {% if is_form_processed %}
      {% if is_ratelimited %}
        Limite de requêtes atteinte. Veuillez réessayer demain.
      {% endif %}
      {% if not documents and not unprocessed %}
        Aucun résultat trouvé, ou vous n'avez pas accès à ce dossier.<br><br>
        Pour obtenir de l'aide, contactez-nous :<br>
        <a target="_blank" href="{{ settings.TCHAP_SUPPORT_CANAL_URL }}">Support - Dépenses Éclairées</a>
        ou par mail à <a href="mailto:contact@depenses-eclairees.beta.gouv.fr">contact@depenses-eclairees.beta.gouv.fr</a>
      {% endif %}

      {% if num_ej %}
        {% if documents or unprocessed %}
        <section class="fr-mb-4w" aria-label="Résumé du dossier">
          <h2 class="fr-h4 fr-mb-2w">
            Dossier n°&nbsp;{{ num_ej }}
          </h2>
          <p class="fr-text fr-text--sm fr-mb-0">
            {% with nb_analyses=documents|length nb_unprocessed=unprocessed|length %}
            <span class="fr-badge fr-badge--success">{{ nb_analyses }} document{{ nb_analyses|pluralize }} analysé{{ nb_analyses|pluralize }} par l'IA</span>
            <span class="fr-badge">{{ nb_analyses|add:nb_unprocessed }} document{{ nb_analyses|add:nb_unprocessed|pluralize }} disponible{{ nb_analyses|add:nb_unprocessed|pluralize }} au total</span>
            {% endwith %}
          </p>
        </section>
        {% endif %}
      {% endif %}

      {# Documents analysés #}
      {% for doc in documents %}
        <section class="fr-accordion" data-fr-js-accordion="true">
          <h3 class="fr-accordion__title">
            <button type="button" class="fr-accordion__btn" aria-expanded="false" aria-controls="{{ doc.id }}" data-fr-js-collapse-button="true">
              <span class="fr-badge fr-badge--info fr-badge--no-icon">{{ doc.short_classification }}</span>
              <span class="fr-ml-1w">{{ doc.filename }}</span>
              <span class="fr-badge fr-badge--sm fr-ml-1w">
                <span class="fr-icon-focus-3-line" aria-hidden="true"></span>&nbsp;{{ doc.percent_data_extraction }} infos remplies
              </span>
            </button>
          </h3>
          {% include "docia/details_ej/documents/document.html" with doc=doc %}
        </section>
      {% endfor %}

      {# Documents non analysés #}
      {% if unprocessed %}
        <section class="fr-accordion fr-mt-4w" data-fr-js-accordion="true">
          <h3 class="fr-accordion__title">
            <button type="button" class="fr-accordion__btn" aria-expanded="false" aria-controls="unprocessed" data-fr-js-collapse-button="true">
              <span class="fr-icon-newspaper-line" aria-hidden="true"></span>&nbsp;Autres documents disponibles (informations non extraites)
            </button>
          </h3>
          <div class="fr-collapse" id="unprocessed" data-fr-js-collapse="true" style="--collapse: -48px;">
            <ul class="fr-list fr-list--none">
              {% for doc in unprocessed %}
              <li class="fr-list__item fr-my-1w">
                <span class="fr-badge fr-badge--info fr-badge--no-icon">{{ doc.short_classification }}</span>
                <span class="fr-ml-1w">{{ doc.filename }}</span>
                <a href="{{ doc.url }}" target="_blank" class="fr-link fr-ml-1w">voir</a>
              </li>
              {% endfor %}
            </ul>
          </div>
        </section>
      {% endif %}
    {% endif %}

  {% else %}
    <a href="{% url 'login' %}">Se connecter</a>
  {% endif %}

  <div style="margin-bottom: 50vh"></div>

  <script src="{% static 'js/clipboard.js' %}" defer></script>
{% endblock %}