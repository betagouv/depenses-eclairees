{% load dsfr_tags static docia %}
{% with id_prefix=doc.filename|add:"_" data=doc.data %}

<div class="fr-mb-4w">
  {# Signataires : entre administration (signataire) et titulaire (societe_principale) #}
  <p class="fr-text--lg fr-mb-1v">
    Acte signé entre <strong>{{ data.administration_beneficiaire|default:"[Non trouvé]" }}</strong> (signataire)
    et <strong>{{ data.societe_principale|upper|default:"[Non trouvé]" }}</strong> (titulaire).
  </p>

  {# Objet : objet_marche visible, lot_concerne en déroulant discret si rempli #}
  <p class="fr-mb-0">
    <strong>Objet :</strong> {{ data.objet_marche|default:"[Non trouvé]" }}
  </p>
  {% if data.lot_concerne %}
    <div class="fr-collapse lot-concerne-content" id="{{ doc.id }}_lot" data-fr-js-collapse="true" style="--collapse: -48px;">
      <p class="fr-mt-1v fr-mb-0 fr-text--sm" style="color: #6a6a6a;">{{ data.lot_concerne }}</p>
    </div>
  {% endif %}
</div>

{# Sous-sections déroulantes (rapprochées, sans saut de ligne) #}
<div class="document-sections fr-mt-2v">
{# Informations générales : forme du marché, code CPV, ligne d'imputation, mode de consultation #}
  {% if data.forme_marche or data.code_cpv or data.ligne_imputation_budgetaire or data.mode_consultation %}
  <section class="fr-accordion" data-fr-js-accordion="true">
    <h3 class="fr-accordion__title">
      <button type="button" class="fr-accordion__btn" aria-expanded="false" aria-controls="{{ doc.id }}_infos_generales" data-fr-js-collapse-button="true">
        Informations générales
      </button>
    </h3>
    <div class="fr-collapse" id="{{ doc.id }}_infos_generales" data-fr-js-collapse="true" style="--collapse: -48px;">
      <ul class="fr-list">
        {% if data.forme_marche %}
          <li class="fr-list__item">
            <span class="fr-text--sm fr-text--mention">Est un marché subséquent&nbsp;</span>
            <span class="fr-text--sm">
              {% if data.forme_marche.marche_subsequent %}
                <span class="fr-icon-check-line" aria-hidden="true"></span> Oui
              {% else %}
                <span class="fr-icon-close-line" aria-hidden="true"></span> Non
              {% endif %}
            </span>
          </li>
          {% with marche_parent=data|get_item:"forme_marche.marche_parent" %}
            {% if data.forme_marche.marche_subsequent and marche_parent %}
              {% with value=marche_parent copy_value=marche_parent %}
                {% include "docia/details_ej/blocks/attribute.html" with title="Marché parent" id=id_prefix|add:"forme_marche.marche_parent" %}
              {% endwith %}
            {% endif %}
          {% endwith %}
          {% with numero_lot=data|get_item:"forme_marche.lot_concerne.numero_lot" titre_lot=data|get_item:"forme_marche.lot_concerne.titre_lot" %}
            {% if numero_lot %}
            <li class="fr-list__item">
              <span class="fr-text--sm fr-text--mention">Lot concerné&nbsp;</span>
              <span class="fr-text--sm">Lot n° {{ numero_lot }}{% if titre_lot %} : {{ titre_lot }}{% endif %}</span>
            </li>
            {% endif %}
          {% endwith %}
        {% endif %}
        {% with value=data.code_cpv copy_value=data.code_cpv %}
          {% include "docia/details_ej/blocks/attribute.html" with title="Code CPV" id=id_prefix|add:"code_cpv" %}
        {% endwith %}
        {% with value=data.ligne_imputation_budgetaire copy_value=data.ligne_imputation_budgetaire %}
          {% include "docia/details_ej/blocks/attribute.html" with title="Ligne d'imputation budgétaire" id=id_prefix|add:"ligne_imputation_budgetaire" %}
        {% endwith %}
        <li class="fr-list__item">
          <span class="fr-text--sm fr-text--mention">Mode de consultation&nbsp;</span>
          <span class="fr-text--sm">{{ data.mode_consultation|default:"Aucune précision dans le document" }}</span>
        </li>
      </ul>
    </div>
  </section>
  {% endif %}

{# Titulaire : déroulant si au moins un des champs (raison sociale, SIREN, SIRET) est disponible #}
  {% if data.societe_principale or data.siren_mandataire or data.siret_mandataire %}
  <section class="fr-accordion" data-fr-js-accordion="true">
    <h3 class="fr-accordion__title">
      <button type="button" class="fr-accordion__btn" aria-expanded="false" aria-controls="{{ doc.id }}_titulaire_detail" data-fr-js-collapse-button="true">
        Titulaire – {{ data.societe_principale|upper|default:"[Non trouvé]" }}
      </button>
    </h3>
    <div class="fr-collapse" id="{{ doc.id }}_titulaire_detail" data-fr-js-collapse="true" style="--collapse: -48px;">
      <ul class="fr-list">
        {% with value=data.societe_principale|upper copy_value=data.societe_principale %}
          {% include "docia/details_ej/blocks/attribute.html" with title="Raison sociale" id=id_prefix|add:"societe_principale" %}
        {% endwith %}
        {% with value=data.siren_mandataire|format_siren_siret copy_value=data.siren_mandataire %}
          {% include "docia/details_ej/blocks/attribute.html" with title="SIREN" id=id_prefix|add:"siren_mandataire" value_class="siren-siret-format" %}
        {% endwith %}
        {% with value=data.siret_mandataire|format_siren_siret copy_value=data.siret_mandataire %}
          {% include "docia/details_ej/blocks/attribute.html" with title="SIRET" id=id_prefix|add:"siret_mandataire" value_class="siren-siret-format" %}
        {% endwith %}
        <li class="fr-list__item">
          <span class="fr-text--sm fr-text--mention">En groupement&nbsp;</span>
          <span class="fr-text--sm">
            {% if data.cotraitants %}
              <span class="fr-icon-check-line" aria-hidden="true"></span> Oui
            {% else %}
              <span class="fr-icon-close-line" aria-hidden="true"></span> Non
            {% endif %}
          </span>
        </li>
      </ul>
    </div>
  </section>
  {% else %}
  <div class="document-section--disabled">
    <span class="document-section--disabled__title">Titulaire – Non disponible dans le document.</span>
  </div>
  {% endif %}

{# Prix et avance : déroulant si au moins un des champs (HT, TTC, TVA, annexes financières, conserve_avance) est disponible #}
  {% if data.montant_ht or data.montant_ttc or data.montant_tva or data.montants_en_annexe or data.conserve_avance %}
    <section class="fr-accordion" data-fr-js-accordion="true">
      <h3 class="fr-accordion__title">
        <button type="button" class="fr-accordion__btn" aria-expanded="false" aria-controls="{{ doc.id }}_prix" data-fr-js-collapse-button="true">
          Prix et avance
        </button>
      </h3>
      <div class="fr-collapse" id="{{ doc.id }}_prix" data-fr-js-collapse="true" style="--collapse: -48px;">
        <ul class="fr-list">
          {% with annexe_financiere=data|get_item:"montants_en_annexe.annexe_financière" annexe_classification=data|get_item:"montants_en_annexe.classification" %}
          {# Montants HT / TTC / TVA : masqués si aucun montant renseigné ET annexe_financière = True (montants en annexe) #}
          {% if data.montant_ht or data.montant_ttc or data.montant_tva or not annexe_financiere %}
            {% with value=data.montant_ht|floatformat:2 copy_value=data.montant_ht %}
              {% include "docia/details_ej/blocks/attribute.html" with title="Montant HT" id=id_prefix|add:"montant_ht" suffix=" €" %}
            {% endwith %}
            {% with value=data.montant_ttc|floatformat:2 copy_value=data.montant_ttc %}
              {% include "docia/details_ej/blocks/attribute.html" with title="Montant TTC" id=id_prefix|add:"montant_ttc" suffix=" €" %}
            {% endwith %}
            {% with value=data.montant_tva|as_percentage copy_value=data.montant_tva %}
              {% include "docia/details_ej/blocks/attribute.html" with title="Taux TVA" id=id_prefix|add:"montant_tva" suffix="" %}
            {% endwith %}
            {% if data.montant_tva_euros is not None %}
              {% with value=data.montant_tva_euros|floatformat:2 copy_value=data.montant_tva_euros %}
                {% include "docia/details_ej/blocks/attribute.html" with title="Montant TVA (calculé)" id=id_prefix|add:"montant_tva_calcule" suffix=" €" %}
              {% endwith %}
            {% endif %}
          {% endif %}
          <li class="fr-list__item">
            <span class="fr-text--sm fr-text--mention">Souhaite conserver l'avance&nbsp;</span>
            <span class="fr-text--sm">
              {% if data.conserve_avance == "conserve" %}
                <span class="fr-icon-check-line" aria-hidden="true"></span> Oui
              {% elif data.conserve_avance == "renonce" %}
                <span class="fr-icon-close-line" aria-hidden="true"></span> Non
              {% else %}
                <span class="fr-text--mention">[Non trouvé]</span>
              {% endif %}
            </span>
          </li>
          <li class="fr-list__item">
            <span class="fr-text--sm fr-text--mention">Annexe(s) financière(s) citée(s)&nbsp;</span>
            <span class="fr-text--sm">
              {% if annexe_financiere is None %}
                <span class="fr-text--mention">Non mentionnée</span>
              {% elif annexe_classification %}
                {{ annexe_classification|join:", " }}
              {% else %}
                <span class="fr-text--mention">Non mentionnée</span>
              {% endif %}
            </span>
          </li>
          {% endwith %}
        </ul>
      </div>
    </section>
  {% else %}
    <div class="document-section--disabled">
      <span class="document-section--disabled__title">Prix et avance – Non disponibles dans le document.</span>
    </div>
  {% endif %}

{# Durée : déroulant si duree_initiale présente et non 0, sinon section grisée #}
  {% with duree=data.duree %}
    {% if duree and duree.duree_initiale %}
      <section class="fr-accordion" data-fr-js-accordion="true">
        <h3 class="fr-accordion__title">
          <button type="button" class="fr-accordion__btn" aria-expanded="false" aria-controls="{{ doc.id }}_duree" data-fr-js-collapse-button="true">
            Durée du marché
          </button>
        </h3>
        <div class="fr-collapse" id="{{ doc.id }}_duree" data-fr-js-collapse="true" style="--collapse: -48px;">
          <p class="fr-mb-2v">
            Durée d'exécution du marché : <strong>{{ duree.duree_initiale }} mois</strong>
            {% if duree.nb_reconductions %}
              (reconductible)
            {% else %}
              (non reconductible)
            {% endif %}
          </p>
          {% if duree.nb_reconductions %}
            <ul class="fr-list">
              {% with value=duree.nb_reconductions %}
                {% include "docia/details_ej/blocks/attribute.html" with title="Nombre de reconductions" id=id_prefix|add:"nb_reconductions" %}
              {% endwith %}
              {% if duree.duree_reconduction %}
                {% with value=duree.duree_reconduction suffix=" mois" %}
                  {% include "docia/details_ej/blocks/attribute.html" with title="Durée d'une reconduction" id=id_prefix|add:"duree_reconduction" %}
                {% endwith %}
              {% endif %}
              {% if duree.nb_reconductions > 1 and data.mode_reconduction %}
                {% with value=data.mode_reconduction|title copy_value=data.mode_reconduction %}
                  {% include "docia/details_ej/blocks/attribute.html" with title="Type reconduction" id=id_prefix|add:"mode_reconduction" %}
                {% endwith %}
              {% endif %}
            </ul>
          {% endif %}
        </div>
      </section>
    {% else %}
      <div class="document-section--disabled">
        <span class="document-section--disabled__title">Durée – Non disponible dans le document.</span>
      </div>
    {% endif %}
  {% endwith %}

{# Informations bancaires : déroulant si banque ou iban, sinon section grisée #}
  {% with banque=data|get_item:"rib_mandataire.banque" iban=data|get_item:"rib_mandataire.iban" %}
    {% if banque or iban %}
      <section class="fr-accordion" data-fr-js-accordion="true">
        <h3 class="fr-accordion__title">
          <button type="button" class="fr-accordion__btn" aria-expanded="false" aria-controls="{{ doc.id }}_rib" data-fr-js-collapse-button="true">
            Informations bancaires
          </button>
        </h3>
        <div class="fr-collapse" id="{{ doc.id }}_rib" data-fr-js-collapse="true" style="--collapse: -48px;">
          <ul class="fr-list">
            {% with value=banque|upper %}
              {% include "docia/details_ej/blocks/attribute.html" with title="Banque" id=id_prefix|add:"banque" %}
            {% endwith %}
            {% with value=iban|iban_spaces copy_value=iban %}
              {% include "docia/details_ej/blocks/attribute.html" with title="IBAN" id=id_prefix|add:"rib_iban" %}
            {% endwith %}
          </ul>
        </div>
      </section>
    {% else %}
      <div class="document-section--disabled">
        <span class="document-section--disabled__title">Informations bancaires – Non disponibles dans le document.</span>
      </div>
    {% endif %}
  {% endwith %}

{# Dates et signatures : déroulant si au moins une date, sinon section grisée #}
  {% if data.date_signature_mandataire or data.date_signature_administration or data.date_notification %}
    <section class="fr-accordion" data-fr-js-accordion="true">
      <h3 class="fr-accordion__title">
        <button type="button" class="fr-accordion__btn" aria-expanded="false" aria-controls="{{ doc.id }}_dates" data-fr-js-collapse-button="true">
          Dates et signatures
        </button>
      </h3>
      <div class="fr-collapse" id="{{ doc.id }}_dates" data-fr-js-collapse="true" style="--collapse: -48px;">
        <ul class="fr-list">
          {% with value=data.date_signature_mandataire %}
            {% include "docia/details_ej/blocks/attribute.html" with title="Signature titulaire" id=id_prefix|add:"date_signature_titulaire" %}
          {% endwith %}
          {% with value=data.date_signature_administration %}
            {% include "docia/details_ej/blocks/attribute.html" with title="Signature signataire" id=id_prefix|add:"date_signature_signataire" %}
          {% endwith %}
          {% with value=data.date_notification %}
            {% include "docia/details_ej/blocks/attribute.html" with title="Date de notification" id=id_prefix|add:"date_notification" %}
          {% endwith %}
        </ul>
      </div>
    </section>
  {% else %}
    <div class="document-section--disabled">
      <span class="document-section--disabled__title">Dates et signatures – Non trouvées dans le document.</span>
    </div>
  {% endif %}

  {# Cotraitants #}
  {% if data.cotraitants %}
  <section class="fr-accordion" data-fr-js-accordion="true">
    <h3 class="fr-accordion__title">
      <button type="button" class="fr-accordion__btn" aria-expanded="false" aria-controls="{{ doc.id }}_cotraitants" data-fr-js-collapse-button="true">
        Cotraitants
      </button>
    </h3>
    <div class="fr-collapse" id="{{ doc.id }}_cotraitants" data-fr-js-collapse="true" style="--collapse: -48px;">
      {% with table_data=data.cotraitants|list_of_dicts_as_table:formatting_data.cotraitants.table_columns %}
        {% dsfr_table content=table_data.rows header=table_data.headers extra_classes='fr-table--no-scroll copyable copyable-all-cells document-table' %}
      {% endwith %}
    </div>
  </section>
  {% endif %}

  {# Sous-Traitants #}
  {% if data.sous_traitants %}
  <section class="fr-accordion" data-fr-js-accordion="true">
    <h3 class="fr-accordion__title">
      <button type="button" class="fr-accordion__btn" aria-expanded="false" aria-controls="{{ doc.id }}_sous_traitants" data-fr-js-collapse-button="true">
        Sous-traitants
      </button>
    </h3>
    <div class="fr-collapse" id="{{ doc.id }}_sous_traitants" data-fr-js-collapse="true" style="--collapse: -48px;">
      {% with table_data=data.sous_traitants|list_of_dicts_as_table:formatting_data.sous_traitants.table_columns %}
        {% dsfr_table content=table_data.rows header=table_data.headers extra_classes='fr-table--no-scroll copyable copyable-all-cells document-table' %}
      {% endwith %}
    </div>
  </section>
  {% endif %}

  {# RIBs (sous-traitants / co-traitants) #}
  {% if data.rib_autres %}
  <section class="fr-accordion" data-fr-js-accordion="true">
    <h3 class="fr-accordion__title">
      <button type="button" class="fr-accordion__btn" aria-expanded="false" aria-controls="{{ doc.id }}_rib_autres" data-fr-js-collapse-button="true">
        RIBs (sous-traitants / co-traitants)
      </button>
    </h3>
    <div class="fr-collapse" id="{{ doc.id }}_rib_autres" data-fr-js-collapse="true" style="--collapse: -48px;">
      {% with table_data=data.rib_autres|list_of_dicts_as_table:formatting_data.rib_autres.table_columns %}
        {% dsfr_table content=table_data.rows header=table_data.headers extra_classes='fr-table--no-scroll copyable copyable-all-cells document-table' %}
      {% endwith %}
    </div>
  </section>
  {% endif %}
</div>
{% endwith %}
